<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lector de Códigos QR Robusto</title>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/opencv.js/4.5.5/opencv.js"></script>
    <style>
        /* Estilos anteriores... */
        #processingCanvas {
            display: none;
        }
        
        .controls {
            margin: 15px 0;
        }
        
        .control-group {
            margin-bottom: 10px;
        }
        
        label {
            display: inline-block;
            width: 120px;
        }
        
        input[type="range"] {
            width: 200px;
        }
    </style>
</head>
<body>
    <h1>Lector de Códigos QR Robusto</h1>
    
    <div class="info-panel">
        <p>Esta aplicación está optimizada para leer códigos QR en condiciones difíciles.</p>
        <p><strong>Recomendaciones:</strong></p>
        <ul>
            <li>Ajusta el contraste y brillo si el código tiene reflejos</li>
            <li>Evita movimientos bruscos al escanear</li>
            <li>Intenta posicionar el código para minimizar reflejos</li>
        </ul>
    </div>
    
    <p id="status">Preparado para escanear</p>
    
    <button id="startButton">Iniciar Escáner</button>
    <button id="stopButton" style="display:none;">Detener Escáner</button>
    
    <div id="videoContainer">
        <video id="video" playsinline autoplay></video>
        <canvas id="canvas"></canvas>
        <canvas id="processingCanvas"></canvas>
        <div id="qrBox"></div>
        
        <div class="controls">
            <div class="control-group">
                <label for="contrastSlider">Contraste:</label>
                <input type="range" id="contrastSlider" min="0.5" max="2.5" step="0.1" value="1.0">
                <span id="contrastValue">1.0</span>
            </div>
            <div class="control-group">
                <label for="brightnessSlider">Brillo:</label>
                <input type="range" id="brightnessSlider" min="-50" max="50" step="1" value="0">
                <span id="brightnessValue">0</span>
            </div>
            <div class="control-group">
                <input type="checkbox" id="preprocessToggle" checked>
                <label for="preprocessToggle">Preprocesamiento avanzado</label>
            </div>
        </div>
    </div>
    
    <div id="resultPanel">
        <!-- Contenido de resultados... igual que antes -->
    </div>
    
    <script>
        // Elementos del DOM
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const videoContainer = document.getElementById('videoContainer');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const processingCanvas = document.getElementById('processingCanvas');
        const qrBox = document.getElementById('qrBox');
        const resultPanel = document.getElementById('resultPanel');
        const resultTableBody = document.getElementById('resultTableBody');
        const newScanButton = document.getElementById('newScanButton');
        const statusText = document.getElementById('status');
        const contrastSlider = document.getElementById('contrastSlider');
        const brightnessSlider = document.getElementById('brightnessSlider');
        const contrastValue = document.getElementById('contrastValue');
        const brightnessValue = document.getElementById('brightnessValue');
        const preprocessToggle = document.getElementById('preprocessToggle');
        
        let stream = null;
        let scanning = false;
        let canvasContext = canvas.getContext('2d');
        let processingContext = processingCanvas.getContext('2d');
        let codeReader = null;
        let opencvReady = false;
        
        // Verificar si OpenCV está listo
        function onOpenCvReady() {
            opencvReady = true;
            statusText.textContent = "Herramientas de procesamiento avanzado listas";
        }
        
        // Si OpenCV ya está cargado
        if (typeof cv !== 'undefined') {
            onOpenCvReady();
        } else {
            // Callback para cuando OpenCV termine de cargar
            window.onOpenCvReady = onOpenCvReady;
        }
        
        // Actualizar valores de los controles
        contrastSlider.addEventListener('input', () => {
            contrastValue.textContent = contrastSlider.value;
        });
        
        brightnessSlider.addEventListener('input', () => {
            brightnessValue.textContent = brightnessSlider.value;
        });
        
        // Iniciar el escáner
        startButton.addEventListener('click', startScanner);
        stopButton.addEventListener('click', stopScanner);
        newScanButton.addEventListener('click', () => {
            resultPanel.style.display = 'none';
            startScanner();
        });
        
        // Función para iniciar el escáner
        async function startScanner() {
            try {
                // Inicializar ZXing
                codeReader = new ZXing.BrowserQRCodeReader();
                
                // Configurar la cámara
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "environment" }
                });
                
                videoContainer.style.display = 'block';
                startButton.style.display = 'none';
                stopButton.style.display = 'inline-block';
                statusText.textContent = 'Escaneando... Apunta al código QR';
                
                // Configurar el video
                video.srcObject = stream;
                await video.play();
                
                // Ajustar el tamaño del canvas al video
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                processingCanvas.width = video.videoWidth;
                processingCanvas.height = video.videoHeight;
                
                // Iniciar el proceso de escaneo
                scanning = true;
                scanQRCode();
                
            } catch (error) {
                console.error('Error accediendo a la cámara:', error);
                statusText.textContent = 'Error al acceder a la cámara';
            }
        }
        
        // Función para detener el escáner
        function stopScanner() {
            scanning = false;
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            video.srcObject = null;
            videoContainer.style.display = 'none';
            startButton.style.display = 'inline-block';
            stopButton.style.display = 'none';
            qrBox.style.display = 'none';
            statusText.textContent = 'Escáner detenido';
        }
        
        // Preprocesar la imagen para mejorar la detección de QR
        function preprocessImage() {
            if (!opencvReady) return null;
            
            try {
                // Dibujar frame actual en processingCanvas
                processingContext.drawImage(video, 0, 0, processingCanvas.width, processingCanvas.height);
                const imageData = processingContext.getImageData(0, 0, processingCanvas.width, processingCanvas.height);
                
                // Convertir imageData a Mat de OpenCV
                const src = cv.matFromImageData(imageData);
                const dst = new cv.Mat();
                
                // Aplicar contraste y brillo
                const contrast = parseFloat(contrastSlider.value);
                const brightness = parseInt(brightnessSlider.value);
                
                // Aplicar contraste y brillo
                src.convertTo(dst, -1, contrast, brightness);
                
                if (preprocessToggle.checked) {
                    // Convertir a escala de grises
                    const gray = new cv.Mat();
                    cv.cvtColor(dst, gray, cv.COLOR_RGBA2GRAY);
                    
                    // Aplicar umbral adaptativo para mejorar la detección de bordes
                    const binary = new cv.Mat();
                    cv.adaptiveThreshold(gray, binary, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 11, 2);
                    
                    // Eliminar ruido
                    const kernel = cv.Mat.ones(5, 5, cv.CV_8U);
                    const processed = new cv.Mat();
                    cv.morphologyEx(binary, processed, cv.MORPH_CLOSE, kernel);
                    
                    // Convertir de vuelta a RGBA para mostrar
                    const result = new cv.Mat();
                    cv.cvtColor(processed, result, cv.COLOR_GRAY2RGBA);
                    
                    // Mostrar la imagen procesada
                    cv.imshow(processingCanvas, result);
                    
                    // Crear un nuevo ImageData para devolver
                    const processedImageData = processingContext.getImageData(0, 0, processingCanvas.width, processingCanvas.height);
                    
                    // Liberar memoria
                    src.delete();
                    dst.delete();
                    gray.delete();
                    binary.delete();
                    kernel.delete();
                    processed.delete();
                    result.delete();
                    
                    return processedImageData;
                } else {
                    // Mostrar imagen con solo ajuste de contraste/brillo
                    cv.imshow(processingCanvas, dst);
                    
                    // Crear un nuevo ImageData para devolver
                    const processedImageData = processingContext.getImageData(0, 0, processingCanvas.width, processingCanvas.height);
                    
                    // Liberar memoria
                    src.delete();
                    dst.delete();
                    
                    return processedImageData;
                }
            } catch (error) {
                console.error('Error en preprocesamiento:', error);
                return null;
            }
        }
        
        // Función para escanear el código QR
        async function scanQRCode() {
            if (!scanning) return;
            
            try {
                // Dibujar el frame actual en el canvas
                canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Preprocesar la imagen si OpenCV está disponible
                const imageData = preprocessImage() || 
                                  canvasContext.getImageData(0, 0, canvas.width, canvas.height);
                
                // Crear un ImageBitmap para ZXing
                const imageBitmap = await createImageBitmap(
                    new ImageData(
                        new Uint8ClampedArray(imageData.data), 
                        imageData.width, 
                        imageData.height
                    )
                );
                
                // Decodificar usando ZXing
                const hints = new Map();
                hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
                hints.set(ZXing.DecodeHintType.PURE_BARCODE, false);
                
                try {
                    const result = codeReader.decodeFromImageBitmap(imageBitmap, hints);
                    
                    if (result) {
                        // Se encontró un código QR
                        console.log("QR Code detected:", result.getText());
                        
                        // Marcar posición del código QR en la interfaz
                        const points = result.getResultPoints();
                        if (points && points.length >= 3) {
                            // Encontrar las coordenadas extremas
                            let minX = canvas.width, minY = canvas.height;
                            let maxX = 0, maxY = 0;
                            
                            for (const point of points) {
                                minX = Math.min(minX, point.getX());
                                minY = Math.min(minY, point.getY());
                                maxX = Math.max(maxX, point.getX());
                                maxY = Math.max(maxY, point.getY());
                            }
                            
                            // Mostrar caja alrededor del QR
                            qrBox.style.display = 'block';
                            qrBox.style.left = `${minX}px`;
                            qrBox.style.top = `${minY}px`;
                            qrBox.style.width = `${maxX - minX}px`;
                            qrBox.style.height = `${maxY - minY}px`;
                            
                            // Detener el escaneo
                            scanning = false;
                            
                            // Mostrar el resultado
                            displayResult(result.getText());
                            return;
                        }
                    }
                } catch (error) {
                    // Error normal durante el escaneo, ignorar
                }
                
                // Limpiar caja si no se detectó código
                qrBox.style.display = 'none';
                
                // Continuar escaneando
                requestAnimationFrame(scanQRCode);
                
            } catch (error) {
                console.error('Error en escaneo:', error);
                statusText.textContent = 'Error en el escaneo: ' + error.message;
                scanning = false;
            }
        }
        
        // Mostrar el resultado
        function displayResult(qrData) {
            // Detener el escáner
            stopScanner();
            
            // Mostrar el resultado
            resultPanel.style.display = 'block';
            resultTableBody.innerHTML = '';
            
            const row = document.createElement('tr');
            
            const idCell = document.createElement('td');
            idCell.textContent = qrData;
            
            const timeCell = document.createElement('td');
            timeCell.textContent = new Date().toLocaleString();
            
            row.appendChild(idCell);
            row.appendChild(timeCell);
            resultTableBody.appendChild(row);
            
            statusText.textContent = `ID escaneado: ${qrData}`;
        }
    </script>
</body>
</html>
